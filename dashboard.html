<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, query, where, onSnapshot, updateDoc, addDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCTxt82Z4KRW425eYAU-WkVJbmUu1Vcy58",
        authDomain: "ispahani-madrasah-portal.firebaseapp.com",
        projectId: "ispahani-madrasah-portal",
        storageBucket: "ispahani-madrasah-portal.firebasestorage.app",
        messagingSenderId: "501627545319",
        appId: "1:501627545319:web:42409b2d8f614dfc3c6442"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- লুপ বন্ধ করার আসল লজিক ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // ১. ডাটাবেজ থেকে ইউজারের তথ্য আনা
            const userRef = doc(db, "admin_users", user.uid);
            const snap = await getDoc(userRef);

            if (snap.exists()) {
                const userData = snap.data();
                
                if (userData.status === "approved") {
                    // ২. শুধুমাত্র এপ্রুভ হলেই ড্যাশবোর্ড দেখাবে
                    document.getElementById('loading-screen').style.display = "none";
                    document.getElementById('u-name').innerText = userData.name;
                    document.getElementById('u-img').src = user.photoURL;
                    
                    // ৩. মাস্টার অ্যাডমিন চেক (সরাসরি তোমার ইমেইল দিয়ে)
                    if (user.email === "abdullahalahadkafi@gmail.com" || userData.designation.toLowerCase().includes("super")) {
                        document.getElementById('master-tab').style.display = "flex";
                        loadPendingTeachers();
                    }
                } else {
                    // এপ্রুভ না হলে তাকে ওয়েটিং স্ক্রিনে আটকে রাখবে (ইনডেক্সে পাঠাবে না)
                    showWaitScreen();
                }
            } else {
                // যদি একাউন্টই না থাকে তবে রেজিস্ট্রেশনে পাঠাবে
                window.location.href = "teacher-onboarding.html";
            }
        } else {
            // লগইন করা না থাকলে শুধু তখনই ইনডেক্সে পাঠাবে
            window.location.href = "index.html";
        }
    });

    // সুপারের জন্য টিচার এপ্রুভাল লজিক (রিয়েল টাইম)
    function loadPendingTeachers() {
        const q = query(collection(db, "admin_users"), where("status", "==", "pending"));
        onSnapshot(q, (snapshot) => {
            const body = document.getElementById('pending-teachers-body');
            body.innerHTML = "";
            snapshot.forEach((userDoc) => {
                const d = userDoc.data();
                body.innerHTML += `
                    <tr>
                        <td>${d.name}</td>
                        <td>${d.email}</td>
                        <td><button class="btn-approve" onclick="approveTeacher('${userDoc.id}')">Approve Now</button></td>
                    </tr>
                `;
            });
        });
    }

    window.approveTeacher = async (uid) => {
        const userRef = doc(db, "admin_users", uid);
        await updateDoc(userRef, { status: "approved" });
        alert("শিক্ষক অনুমোদিত হয়েছে! উনি এখন ড্যাশবোর্ড ব্যবহার করতে পারবেন।");
    }

    function showWaitScreen() {
        document.getElementById('loading-screen').innerHTML = `
            <div style="text-align:center; color:white;">
                <i class="fas fa-clock fa-4x" style="color:#ffc107"></i>
                <h1 style="margin-top:20px;">অনুমোদনের অপেক্ষায়...</h1>
                <p>সুপারিনটেনডেন্ট অনুমোদন দিলে আপনি অটোমেটিক ড্যাশবোর্ডে ঢুকতে পারবেন।</p>
                <br><button onclick="location.reload()" style="padding:10px 20px; cursor:pointer;">Refresh Page</button>
            </div>
        `;
    }

    window.showTab = (id, el) => {
        document.querySelectorAll('.tab-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active');
        document.getElementById('tab-name').innerText = el.innerText;
    }

    window.logout = () => signOut(auth).then(() => window.location.href = "index.html");
</script>