<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ইউজার ম্যানেজমেন্ট | IDM Admin Elite</title>
    
    <!-- Premium Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&family=Poppins:wght@600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --p-green: #006a4e; --fb-blue: #1877f2; --bg: #f0f2f5; --white: #fff; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Hind Siliguri', sans-serif; background: var(--bg); display: flex; }

        /* --- SIDEBAR --- */
        .sidebar { width: 280px; height: 100vh; background: #0f172a; color: white; position: fixed; padding: 25px; }
        .sidebar h2 { font-family: 'Poppins'; font-size: 20px; color: #f42a41; text-align: center; margin-bottom: 30px; border-bottom: 1px solid #334155; padding-bottom: 10px; }
        .nav-item { padding: 12px 15px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 12px; margin-bottom: 8px; color: #94a3b8; transition: 0.3s; }
        .nav-item:hover, .nav-item.active { background: var(--p-green); color: white; }

        /* --- MAIN CONTENT --- */
        .main-content { margin-left: 280px; width: 100%; padding: 40px; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        .admin-card { background: white; padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #e5e7eb; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-box { background: white; padding: 20px; border-radius: 15px; text-align: center; border-bottom: 4px solid var(--p-green); }
        .stat-box h3 { font-size: 24px; color: var(--p-green); }

        /* Data Table */
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 15px; border-bottom: 1px solid #f1f5f9; text-align: left; }
        th { background: #f8fafc; color: #1e293b; font-weight: 800; font-size: 14px; }
        
        .u-pic { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .role-pill { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .role-student { background: #e0f2fe; color: #0369a1; }
        .role-teacher { background: #fef3c7; color: #92400e; }
        .role-guardian { background: #f0fdf4; color: #15803d; }

        /* Action Buttons */
        .action-btn { width: 35px; height: 35px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; text-decoration: none; color: white; margin-right: 5px; transition: 0.3s; }
        .btn-call { background: #10b981; }
        .btn-wa { background: #25d366; }
        .btn-mail { background: #ef4444; }
        .action-btn:hover { transform: scale(1.1); }

        /* Access Denied Shield */
        #access-shield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; }

        @media (max-width: 900px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; padding: 20px; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <!-- Security Check Screen -->
    <div id="access-shield">
        <i class="fas fa-user-secret fa-5x" style="color: var(--p-green); margin-bottom: 20px;"></i>
        <h1>নিরাপত্তা যাচাই করা হচ্ছে...</h1>
        <p>শুধুমাত্র অ্যাডমিনরাই এই ডাটাবেজ দেখতে পারবেন।</p>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <h2>IDM MASTER</h2>
        <div class="nav-item active"><i class="fas fa-users"></i> ইউজার লিস্ট</div>
        <div class="nav-item"><i class="fas fa-chart-line"></i> পরিসংখ্যান</div>
        <div class="nav-item" style="margin-top: 50px; color: #f87171;" onclick="location.href='index.html'"><i class="fas fa-power-off"></i> লগআউট</div>
    </aside>

    <main class="main-content">
        <div class="header-bar">
            <h1>মাস্টার ইউজার ডাটাবেজ</h1>
            <div id="admin-name" style="font-weight: bold; color: var(--p-green);">অ্যাডমিন: লোড হচ্ছে...</div>
        </div>

        <!-- Quick Stats -->
        <div class="stats-grid">
            <div class="stat-box"><h3><span id="count-student">0</span></h3><p>মোট ছাত্র</p></div>
            <div class="stat-box"><h3><span id="count-teacher">0</span></h3><p>মোট শিক্ষক</p></div>
            <div class="stat-box"><h3><span id="count-guardian">0</span></h3><p>মোট অভিভাবক</p></div>
        </div>

        <!-- Users Table -->
        <div class="admin-card">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ছবি</th>
                            <th>নাম</th>
                            <th>শ্রেণী/পদবী</th>
                            <th>রোল/আইডি</th>
                            <th>মোবাইল নম্বর</th>
                            <th>রক্ত</th>
                            <th>যোগাযোগ</th>
                        </tr>
                    </thead>
                    <tbody id="user-table-body">
                        <!-- ডাটাবেজ থেকে অটো আসবে -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAT-lcLWb8A9iWJZI77-TJifcjabjSBahU",
            authDomain: "ispahani-madrasah-portal.firebaseapp.com",
            projectId: "ispahani-madrasah-portal",
            storageBucket: "ispahani-madrasah-portal.firebasestorage.app",
            messagingSenderId: "501627545319",
            appId: "1:501627545319:web:42409b2d8f614dfc3c6442"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ১. অ্যাডমিন সিকিউরিটি চেক (শুধুমাত্র তোমার ইমেইল এক্সেস পাবে)
        const allowedAdmins = ["abdullahalahadkafi@gmail.com", "info.idm@gmail.com"];

        onAuthStateChanged(auth, (user) => {
            if (user && allowedAdmins.includes(user.email)) {
                document.getElementById('access-shield').style.display = "none";
                document.getElementById('admin-name').innerText = "অ্যাডমিন: " + user.displayName;
                loadAllUsers();
            } else {
                document.getElementById('access-shield').innerHTML = `
                    <h1 style="color:red">Access Denied! ❌</h1>
                    <p>আপনার এই পেজটি দেখার অনুমতি নেই।</p>
                    <br><a href="index.html" style="color:white; text-decoration:underline;">হোমে ফিরে যান</a>
                `;
            }
        });

        // ২. ডাটাবেজ থেকে সব ইউজার লোড করা
        function loadAllUsers() {
            const q = query(collection(db, "public_users"));
            
            onSnapshot(q, (snapshot) => {
                const body = document.getElementById('user-table-body');
                body.innerHTML = "";
                
                let sCount = 0, tCount = 0, gCount = 0;

                snapshot.forEach((doc) => {
                    const u = doc.data();
                    
                    // কাউন্টার আপডেট
                    if(u.role === 'student') sCount++;
                    if(u.role === 'teacher') tCount++;
                    if(u.role === 'guardian') gCount++;

                    const roleClass = `role-${u.role}`;
                    
                    body.innerHTML += `
                        <tr>
                            <td><img src="${u.photo || 'https://via.placeholder.com/40'}" class="u-pic"></td>
                            <td><b>${u.name}</b><br><small style="color:#888">${u.email}</small></td>
                            <td><span class="role-pill ${roleClass}">${u.role}</span><br>${u.info || 'N/A'}</td>
                            <td>${u.roll || '---'}</td>
                            <td>${u.phone || '---'}</td>
                            <td><b style="color:red">${u.blood || ''}</b></td>
                            <td>
                                <a href="tel:${u.phone}" class="action-btn btn-call"><i class="fas fa-phone"></i></a>
                                <a href="https://wa.me/${u.phone}" target="_blank" class="action-btn btn-wa"><i class="fab fa-whatsapp"></i></a>
                                <a href="mailto:${u.email}" class="action-btn btn-mail"><i class="fas fa-envelope"></i></a>
                            </td>
                        </tr>
                    `;
                });

                document.getElementById('count-student').innerText = sCount;
                document.getElementById('count-teacher').innerText = tCount;
                document.getElementById('count-guardian').innerText = gCount;
            });
        }
    </script>
</body>
</html>